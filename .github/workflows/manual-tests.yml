name: Manual Tests

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Which service(s) to test'
        required: true
        type: choice
        options:
          - collector
          - api
          - processor
          - migrations
          - all
        default: 'collector'
      coverage:
        description: 'Generate coverage reports'
        required: false
        type: boolean
        default: true
      upload_artifacts:
        description: 'Upload test results and coverage as artifacts'
        required: false
        type: boolean
        default: true
      test_method:
        description: 'Test execution method'
        required: false
        type: choice
        options:
          - poetry
          - docker
        default: 'poetry'

jobs:
  # Test the collector service (currently the only service with tests)
  test-collector:
    if: ${{ github.event.inputs.service == 'collector' || github.event.inputs.service == 'all' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            collector/.venv
          key: ${{ runner.os }}-poetry-collector-${{ hashFiles('collector/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-collector-
            
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
          
      - name: Install collector dependencies
        working-directory: ./collector
        run: |
          poetry install --with test
          
      - name: Run collector tests
        working-directory: ./collector
        env:
          # Set required environment variables for tests
          API_URL: "https://test-api.example.com"
          POLLING_INTERVAL_SECONDS: "10"
          REDIS_HOST: "localhost"
          REDIS_DOCKER_PORT: "6379"
          REDIS_STREAM_NAME: "test_stream"
        run: |
          if [ "${{ github.event.inputs.coverage }}" == "true" ]; then
            poetry run pytest --cov=app --cov-report=term --cov-report=xml --cov-report=html --cov-fail-under=90 -v
          else
            poetry run pytest -v
          fi
          
      - name: Upload collector test results
        if: ${{ github.event.inputs.upload_artifacts == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: collector-test-results-py${{ matrix.python-version }}
          path: |
            collector/htmlcov/
            collector/coverage.xml
            collector/.coverage
          retention-days: 30
          
      - name: Upload collector coverage to Codecov (optional)
        if: ${{ github.event.inputs.coverage == 'true' }}
        uses: codecov/codecov-action@v3
        with:
          file: ./collector/coverage.xml
          flags: collector
          name: collector-coverage
          fail_ci_if_error: false

  # Test the API service
  test-api:
    if: ${{ github.event.inputs.service == 'api' || github.event.inputs.service == 'all' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]  # API uses Python 3.12
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            api/.venv
          key: ${{ runner.os }}-poetry-api-${{ hashFiles('api/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-api-
            
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
          
      - name: Install API dependencies
        working-directory: ./api
        run: |
          poetry install
          
      - name: Run API tests (Poetry)
        if: ${{ github.event.inputs.test_method == 'poetry' }}
        working-directory: ./api
        env:
          # Set required environment variables for tests
          DATABASE_URL: "sqlite:///test.db"
          REDIS_URL: "redis://localhost:6379/0"
          VERSION: "test"
        run: |
          if [ "${{ github.event.inputs.coverage }}" == "true" ]; then
            poetry run pytest --cov=app --cov-report=term --cov-report=xml --cov-report=html --cov-fail-under=85 -v
          else
            poetry run pytest -v
          fi

      - name: Run API tests (Docker)
        if: ${{ github.event.inputs.test_method == 'docker' }}
        working-directory: .
        run: |
          # Create .env file for docker-compose
          echo "DATABASE_URL=postgresql://test:test@db:5432/test" > .env
          echo "POSTGRES_USER=test" >> .env
          echo "POSTGRES_PASSWORD=test" >> .env
          echo "POSTGRES_DB=test" >> .env
          echo "REDIS_URL=redis://redis:6379/0" >> .env
          echo "VERSION=test" >> .env
          echo "ENVIRONMENT=test" >> .env
          echo "API_DOCKER_PORT=8000" >> .env
          echo "PGADMIN_DOCKER_PORT=5050" >> .env
          echo "REDIS_INSIGHT_DOCKER_PORT=8001" >> .env
          
          # Install test dependencies and run tests in Docker
          if [ "${{ github.event.inputs.coverage }}" == "true" ]; then
            docker compose run --rm api bash -c "pip install pytest pytest-asyncio pytest-cov httpx pytest-mock fakeredis && pytest tests/ --cov=app --cov-report=term --cov-report=xml --cov-report=html --cov-fail-under=85 -v"
          else
            docker compose run --rm api bash -c "pip install pytest pytest-asyncio pytest-cov httpx pytest-mock fakeredis && pytest tests/ -v"
          fi
          
      - name: Upload API test results
        if: ${{ github.event.inputs.upload_artifacts == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results-py${{ matrix.python-version }}
          path: |
            api/htmlcov/
            api/coverage.xml
            api/.coverage
          retention-days: 30

  # Test the processor service
  test-processor:
    if: ${{ github.event.inputs.service == 'processor' || github.event.inputs.service == 'all' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]  # Processor uses Python 3.11
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            processor/.venv
          key: ${{ runner.os }}-poetry-processor-${{ hashFiles('processor/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-processor-
            
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
          
      - name: Install processor dependencies
        working-directory: ./processor
        run: |
          poetry install --with test  # Will need to add test dependencies
          
      - name: Run processor tests
        working-directory: ./processor
        run: |
          if [ "${{ github.event.inputs.coverage }}" == "true" ]; then
            poetry run pytest --cov=app --cov-report=term --cov-report=xml --cov-report=html -v
          else
            poetry run pytest -v
          fi
          
      - name: Upload processor test results
        if: ${{ github.event.inputs.upload_artifacts == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: processor-test-results-py${{ matrix.python-version }}
          path: |
            processor/htmlcov/
            processor/coverage.xml
            processor/.coverage
          retention-days: 30

  # Placeholder for Migrations tests (uncomment when tests are added)
  test-migrations:
    if: ${{ (github.event.inputs.service == 'migrations' || github.event.inputs.service == 'all') && false }}  # Set to true when migration tests exist
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]  # Migrations use Python 3.12
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            migrations/.venv
          key: ${{ runner.os }}-poetry-migrations-${{ hashFiles('migrations/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-migrations-
            
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
          
      - name: Install migrations dependencies
        working-directory: ./migrations
        run: |
          poetry install --with test  # Will need to add test dependencies
          
      - name: Run migration tests
        working-directory: ./migrations
        run: |
          if [ "${{ github.event.inputs.coverage }}" == "true" ]; then
            poetry run pytest --cov=. --cov-report=term --cov-report=xml --cov-report=html -v
          else
            poetry run pytest -v
          fi
          
      - name: Upload migrations test results
        if: ${{ github.event.inputs.upload_artifacts == 'true' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: migrations-test-results-py${{ matrix.python-version }}
          path: |
            migrations/htmlcov/
            migrations/coverage.xml
            migrations/.coverage
          retention-days: 30

  # Summary job that runs after all tests complete
  test-summary:
    if: always()
    needs: [test-collector, test-api, test-processor]  # Add other jobs here when they're enabled: test-migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Test Results Summary
        run: |
          echo "üß™ Test Execution Summary"
          echo "========================="
          echo "Service: ${{ github.event.inputs.service }}"
          echo "Coverage: ${{ github.event.inputs.coverage }}"
          echo "Upload Artifacts: ${{ github.event.inputs.upload_artifacts }}"
          echo ""
          echo "Job Results:"
          
          # Check collector results
          if [ "${{ needs.test-collector.result }}" != "" ]; then
            echo "- Collector: ${{ needs.test-collector.result }}"
          fi
          
          # Check API results
          if [ "${{ needs.test-api.result }}" != "" ]; then
            echo "- API: ${{ needs.test-api.result }}"
          fi
          
          # Check processor results
          if [ "${{ needs.test-processor.result }}" != "" ]; then
            echo "- Processor: ${{ needs.test-processor.result }}"
          fi
          
          # Future: Add other service results here when enabled
          # echo "- Migrations: ${{ needs.test-migrations.result }}"
          
          echo ""
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo "‚ùå Some tests failed! Check the job logs for details."
            exit 1
          else
            echo "‚úÖ All tests passed successfully!"
          fi